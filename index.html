<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chat Scriptata iOS Finalissima</title>
    
    <style>
        /* Impostazioni globali */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            -webkit-font-smoothing: antialiased; 
            text-rendering: optimizeLegibility;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #ffffff; 
            display: flex;
            justify-content: center; 
            align-items: center; 
            height: 100vh; 
            overflow: hidden; 
        }

        /* Lo schermo centrato (responsive) */
        #chat-container {
            width: 100%;
            max-width: 400px; 
            height: 100vh; 
            background-color: #ffffff;
            display: flex;
            flex-direction: column;
            overflow: hidden; 
        }
        
        /* Finestra dove appaiono i messaggi (Auto-scroll) */
        #chat-window {
            flex-grow: 1; 
            padding: 20px 10px;
            overflow-y: auto; 
            display: flex;
            flex-direction: column;
            gap: 10px; 
            -webkit-overflow-scrolling: touch; 
        }

        /* Stile generico per una bolla di messaggio */
        .message {
            padding: 12px 18px;
            line-height: 1.4;
            max-width: 75%;
            word-wrap: break-word;
            opacity: 0;
            transform: scale(0.9);
            animation: pop-in 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            position: relative; 
        }

        /* Forme delle bolle iMessage (Destinatario: punta in basso a sinistra) */
        .message.recipient {
            align-self: flex-start;
            background-color: #e5e5ea;
            color: #000000;
            border-top-left-radius: 18px;
            border-top-right-radius: 18px;
            border-bottom-right-radius: 18px;
            border-bottom-left-radius: 4px; 
        }

        /* Forme delle bolle iMessage (Mittente: punta in basso a destra) */
        .message.sender {
            align-self: flex-end;
            background-color: #007aff;
            color: #ffffff;
            border-top-left-radius: 18px;
            border-top-right-radius: 18px;
            border-bottom-left-radius: 18px;
            border-bottom-right-radius: 4px; 
        }


        /* Indicatore "Sta scrivendo..." */
        #typing-indicator {
            display: none; 
            align-self: flex-start;
            background-color: #e5e5ea;
            color: #000000;
            
            /* Spaziatura intorno ai puntini (più respiro) */
            padding: 12px 18px 12px 18px; 
            
            /* Bordi come messaggio ricevuto */
            border-top-left-radius: 18px;
            border-top-right-radius: 18px;
            border-bottom-right-radius: 18px;
            border-bottom-left-radius: 4px; 
            
            width: auto; 
            height: auto; 
            
            display: flex; 
            align-items: center;
            justify-content: center; 
            box-sizing: content-box; 
            position: relative;
        }

        /* Animazione puntini iOS */
        @keyframes ios-dot-bounce {
            0%, 75%, 100% { transform: translateY(0); opacity: 0.6; }
            25% { transform: translateY(-3px); opacity: 1; }
        }

        .dots span {
            display: inline-block;
            /* Dimensioni puntini */
            width: 10px; 
            height: 10px; 
            background-color: #b0b0b0; 
            border-radius: 50%;
            margin: 0 3px; 
            animation: ios-dot-bounce 1.5s infinite ease-in-out; 
        }

        .dots span:nth-child(1) { animation-delay: 0s; }
        .dots span:nth-child(2) { animation-delay: 0.1s; } 
        .dots span:nth-child(3) { animation-delay: 0.2s; }
        
        @keyframes pop-in {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }

        /* Barra di input finta */
        #fake-input-bar {
            padding: 10px 15px;
            border-top: none; 
            background-color: #ffffff; 
            padding-bottom: 25px; 
        }

        /* Contenitore della barra di testo */
        #fake-input-box {
            border: none;
            background-color: #f0f2f5; 
            border-radius: 20px;
            height: 40px;
            display: flex;
            align-items: center;
            padding-left: 15px;
            font-size: 1rem;
            position: relative; 
            overflow: hidden; 
        }

        /* Elemento testuale normale "Messaggio" */
        #input-typing-text {
            color: #8e8e93; 
            display: block;
            white-space: nowrap; 
        }

        /* Testo digitato dal Mittente (Contenitore + Cursore) */
        #input-message-typing-container {
            display: none;
            position: relative;
            height: 100%;
            display: flex;
            align-items: center;
            padding-right: 2px; 
        }
        
        #input-message-typing {
            color: #000000; 
            white-space: nowrap;
            overflow: hidden;
            font-size: 1rem;
        }

        /* Animazione Cursore */
        .caret {
            width: 2px;
            height: 70%;
            background-color: #007aff; 
            margin-left: 1px;
            animation: blink-caret 0.8s infinite;
        }

        @keyframes blink-caret {
            from, to { opacity: 0; }
            50% { opacity: 1; }
        }

    </style>
</head>
<body>

    <div id="chat-container">

        <div id="chat-window">
            <div id="typing-indicator" class="dots">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>

        <div id="fake-input-bar">
            <div id="fake-input-box">
                <span id="input-typing-text">Messaggio</span>
                
                <div id="input-message-typing-container">
                    <span id="input-message-typing"></span>
                    <span class="caret"></span>
                </div>
            </div>
        </div>
    </div>

    <audio id="typing-audio" loop>
        <source src="typing_sound.mp3" type="audio/mpeg">
    </audio>
    <audio id="receive-audio">
        <source src="message_received.mp3" type="audio/mpeg">
    </audio>


    <script>
        document.addEventListener("DOMContentLoaded", function() {

            const chatWindow = document.getElementById('chat-window');
            const typingIndicator = document.getElementById('typing-indicator'); 
            const inputTypingText = document.getElementById('input-typing-text'); 
            const inputMessageTypingContainer = document.getElementById('input-message-typing-container');
            const inputMessageTyping = document.getElementById('input-message-typing'); 
            
            // Audio elements
            const typingAudio = document.getElementById('typing-audio');
            const receiveAudio = document.getElementById('receive-audio');

            const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

            // =================================================================
            // === QUI PUOI MODIFICARE LA CONVERSAZIONE ===
            // Ogni blocco ha un 'type' (azione) e un 'delay' (ritardo prima della prossima azione).
            // =================================================================
            const conversationScript = [
                { type: 'typing', delay: 1000 },
                { type: 'message', sender: 'recipient', text: 'Ehi, ci sei?', delay: 2000 },
                
                { type: 'sender_text_typing', text: 'Ciao! Sì, scusa.', delay: 1500 }, 
                { type: 'message', sender: 'sender', text: 'Ciao! Sì, scusa.', delay: 500 }, 
                
                { type: 'sender_text_typing', text: 'Dimmi tutto.', delay: 1000 },
                { type: 'message', sender: 'sender', text: 'Dimmi tutto.', delay: 500 },
                
                { type: 'typing', delay: 1000 },
                { type: 'message', sender: 'recipient', text: 'Volevo solo sapere se stasera ti andava di ordinare una pizza.', delay: 2500 },
                
                { type: 'sender_text_typing', text: 'ASSOLUTAMENTE SÌ.', delay: 1800 },
                { type: 'message', sender: 'sender', text: 'ASSOLUTAMENTE SÌ.', delay: 200 },
                
                { type: 'typing', delay: 1000 },
                { type: 'message', sender: 'recipient', text: 'Perfetto, sentiamoci verso le 19:30!', delay: 2000 }
            ];
            // =================================================================


            function addMessage(text, senderClass) {
                const messageElement = document.createElement('div');
                messageElement.classList.add('message', senderClass);
                messageElement.textContent = text;
                chatWindow.insertBefore(messageElement, typingIndicator);
                chatWindow.scrollTop = chatWindow.scrollHeight; 
                
                if (senderClass === 'recipient') {
                    receiveAudio.play().catch(e => console.log("Errore riproduzione audio ricezione:", e));
                }
            }

            function showTyping() { 
                typingIndicator.style.display = 'flex'; 
                chatWindow.scrollTop = chatWindow.scrollHeight; 
            }
            function hideTyping() { typingIndicator.style.display = 'none'; }

            async function typeSenderMessage(text, duration) {
                inputTypingText.style.display = 'none';
                inputMessageTypingContainer.style.display = 'flex'; 
                inputMessageTyping.textContent = ''; 
                
                // Avvia il suono di digitazione in loop
                typingAudio.play().catch(e => console.log("Errore riproduzione audio digitazione:", e));
                
                const charDelay = duration / text.length; 
                
                for (let i = 0; i < text.length; i++) {
                    inputMessageTyping.textContent += text.charAt(i);
                    chatWindow.scrollTop = chatWindow.scrollHeight; 
                    await sleep(charDelay);
                }
                
                // Ferma il suono di digitazione alla fine
                typingAudio.pause();
                typingAudio.currentTime = 0; 
            }

            function resetInputBar() {
                inputTypingText.style.display = 'block';
                inputMessageTypingContainer.style.display = 'none';
                inputMessageTyping.textContent = '';
                
                // Assicurati che l'audio di digitazione sia spento
                typingAudio.pause();
                typingAudio.currentTime = 0;
            }

            async function runChatScript() {
                hideTyping();
                resetInputBar();

                for (const step of conversationScript) {
                    await sleep(step.delay);

                    if (step.type === 'message') {
                        hideTyping();
                        resetInputBar(); 
                        addMessage(step.text, step.sender);
                    } else if (step.type === 'typing') { 
                        showTyping();
                    } else if (step.type === 'sender_text_typing') { 
                        await typeSenderMessage(step.text, step.delay);
                    }
                }

                // Pausa di 15 secondi prima di ricominciare
                await sleep(15000); 

                const messages = chatWindow.querySelectorAll('.message');
                messages.forEach(msg => msg.remove());
                
                hideTyping();
                resetInputBar();

                await sleep(500);
                runChatScript(); 
            }

            runChatScript();

        });
    </script>

</body>
</html>
