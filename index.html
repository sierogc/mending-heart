<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Due Chat Randomiche Indipendenti</title>
    
    <style>
        /* Impostazioni globali */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            -webkit-font-smoothing: antialiased; 
            text-rendering: optimizeLegibility;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #ffffff; 
            display: flex;
            justify-content: center; 
            align-items: center; 
            height: 100vh; 
            overflow-x: auto; 
        }

        /* Contenitore Principale per le Due Chat */
        #main-container {
            display: flex;
            gap: 40px; 
            padding: 20px;
            height: 100%;
            align-items: center;
        }

        /* Lo schermo centrato (responsive) */
        .chat-container {
            width: 100%;
            max-width: 400px; 
            height: 95vh; 
            background-color: #ffffff;
            display: flex;
            flex-direction: column;
            overflow: hidden; 
            border: none; 
            box-shadow: none;
        }
        
        /* Finestra dove appaiono i messaggi (Auto-scroll) */
        .chat-window {
            flex-grow: 1; 
            padding: 20px 10px;
            overflow-y: auto; 
            display: flex;
            flex-direction: column;
            gap: 10px; 
            -webkit-overflow-scrolling: touch; 
        }

        /* Stile generico per una bolla di messaggio */
        .message {
            padding: 12px 18px;
            line-height: 1.4;
            max-width: 75%;
            word-wrap: break-word;
            opacity: 0;
            transform: scale(0.9);
            animation: pop-in 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            position: relative; 
        }

        /* Forme delle bolle iMessage (Destinatario: punta in basso a sinistra) */
        .message.recipient {
            align-self: flex-start;
            background-color: #e5e5ea;
            color: #000000;
            border-top-left-radius: 18px;
            border-top-right-radius: 18px;
            border-bottom-right-radius: 18px;
            border-bottom-left-radius: 4px; 
        }

        /* Forme delle bolle iMessage (Mittente: punta in basso a destra) */
        .message.sender {
            align-self: flex-end;
            background-color: #007aff;
            color: #ffffff;
            border-top-left-radius: 18px;
            border-top-right-radius: 18px;
            border-bottom-left-radius: 18px;
            border-bottom-right-radius: 4px; 
        }


        /* Indicatore "Sta scrivendo..." */
        .typing-indicator {
            display: none; 
            align-self: flex-start;
            background-color: #e5e5ea;
            color: #000000;
            
            padding: 12px 18px 12px 18px; 
            
            border-top-left-radius: 18px;
            border-top-right-radius: 18px;
            border-bottom-right-radius: 18px;
            border-bottom-left-radius: 4px; 
            
            width: auto; 
            height: auto; 
            
            display: flex; 
            align-items: center;
            justify-content: center; 
            box-sizing: content-box; 
            position: relative;
        }

        /* Animazione puntini iOS (Fade da sinistra a destra) */
        @keyframes ios-dot-fade {
            0%, 80%, 100% { opacity: 0.3; } 
            40% { opacity: 1; } 
        }

        .dots span {
            display: inline-block;
            width: 10px; 
            height: 10px; 
            background-color: #b0b0b0; 
            border-radius: 50%;
            margin: 0 3px; 
            animation: ios-dot-fade 1.5s infinite ease-in-out; 
        }

        .dots span:nth-child(1) { animation-delay: 0s; }
        .dots span:nth-child(2) { animation-delay: 0.2s; } 
        .dots span:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes pop-in {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }

        /* Barra di input finta */
        .fake-input-bar {
            padding: 10px 15px;
            border-top: none; 
            background-color: #ffffff; 
            padding-bottom: 25px; 
        }

        /* Contenitore della barra di testo */
        .fake-input-box {
            border: none;
            background-color: #f0f2f5; 
            border-radius: 20px;
            height: 40px;
            display: flex;
            align-items: center;
            padding-left: 15px;
            font-size: 1rem;
            position: relative; 
            overflow: hidden; 
        }

        /* Elemento testuale normale "Messaggio" */
        .input-typing-text {
            color: #8e8e93; 
            display: block;
            white-space: nowrap; 
        }

        /* Testo digitato dal Mittente (Contenitore + Cursore) */
        .input-message-typing-container {
            display: none;
            position: relative;
            height: 100%;
            display: flex;
            align-items: center;
            padding-right: 2px; 
        }
        
        .input-message-typing {
            color: #000000; 
            white-space: nowrap;
            overflow: hidden;
            font-size: 1rem;
        }

        /* Animazione Cursore */
        .caret {
            width: 2px;
            height: 70%;
            background-color: #007aff; 
            margin-left: 1px;
            animation: blink-caret 0.8s infinite;
        }

        @keyframes blink-caret {
            from, to { opacity: 0; }
            50% { opacity: 1; }
        }

    </style>
</head>
<body>

    <div id="main-container">
        <div id="chat-container-1" class="chat-container">
            <div id="chat-window-1" class="chat-window">
                <div id="typing-indicator-1" class="typing-indicator dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
            <div class="fake-input-bar">
                <div class="fake-input-box">
                    <span id="input-typing-text-1" class="input-typing-text">Messaggio</span>
                    <div id="input-message-typing-container-1" class="input-message-typing-container">
                        <span id="input-message-typing-1" class="input-message-typing"></span>
                        <span class="caret"></span>
                    </div>
                </div>
            </div>
        </div>

        <div id="chat-container-2" class="chat-container">
            <div id="chat-window-2" class="chat-window">
                <div id="typing-indicator-2" class="typing-indicator dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
            <div class="fake-input-bar">
                <div class="fake-input-box">
                    <span id="input-typing-text-2" class="input-typing-text">Messaggio</span>
                    <div id="input-message-typing-container-2" class="input-message-typing-container">
                        <span id="input-message-typing-2" class="input-message-typing"></span>
                        <span class="caret"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <audio id="typing-audio" loop>
        <source src="typing_sound.mp3" type="audio/mpeg">
    </audio>
    <audio id="receive-audio">
        <source src="message_received.mp3" type="audio/mpeg">
    </audio>


    <script>
        document.addEventListener("DOMContentLoaded", function() {

            const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));
            const typingAudio = document.getElementById('typing-audio');
            const receiveAudio = document.getElementById('receive-audio');

            // =================================================================
            // === MESSAGGI BASE E GENERAZIONE RANDOMICA ===
            // =================================================================

            const senderMessages = [
                'Ciao! Sì, scusa.',
                'Dimmi tutto.',
                'ASSOLUTAMENTE SÌ.',
                'Perfetto, ci sentiamo dopo.',
                'Non preoccuparti, arrivo in 5 minuti.',
                'A che ora ci vediamo stasera?',
                'OK, prenoto io il tavolo.',
                'Ci sto! Che ne dici di quella nuova pizzeria?'
            ];

            const fixedRecipientStart = 'Ehi, ci sei?';
            const recipientMessagesPool = [
                'Volevo solo sapere se ti andava di ordinare una pizza.',
                'Perfetto, sentiamoci verso le 19:30!',
                'Quando arrivi? Ti aspetto fuori.',
                'Hai già mangiato?',
                'Mi fai sapere il prima possibile, grazie.',
                'Sì, ho visto il messaggio, grazie.',
                'Assolutamente, ottima idea.'
            ];

            function shuffleArray(array) {
                const newArray = [...array];
                for (let i = newArray.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
                }
                return newArray;
            }

            function generateRandomScript() {
                const shuffledSender = shuffleArray(senderMessages);
                const shuffledRecipientBody = shuffleArray(recipientMessagesPool);
                
                const script = [];
                let senderIndex = 0;
                let recipientIndex = 0;

                // 1. Inserisci la frase iniziale fissa del destinatario
                script.push({ type: 'typing', delay: Math.floor(Math.random() * 1000) + 500 });
                script.push({ type: 'message', sender: 'recipient', text: fixedRecipientStart, delay: Math.floor(Math.random() * 1500) + 1000 });
                
                // 2. Continua con il corpo della conversazione casuale finché ci sono messaggi
                while (senderIndex < shuffledSender.length || recipientIndex < shuffledRecipientBody.length) {
                    
                    const startWithRecipient = Math.random() < 0.5;

                    // Gestione del turno del Destinatario (usando i messaggi rimanenti del pool)
                    if (startWithRecipient && recipientIndex < shuffledRecipientBody.length) {
                        script.push({ type: 'typing', delay: Math.floor(Math.random() * 1000) + 500 });
                        script.push({ type: 'message', sender: 'recipient', text: shuffledRecipientBody[recipientIndex], delay: Math.floor(Math.random() * 1500) + 1000 });
                        recipientIndex++;
                    }

                    // Gestione del turno del Mittente
                    if (senderIndex < shuffledSender.length) {
                        const typingTime = shuffledSender[senderIndex].length * (Math.random() * 50 + 50); 
                        script.push({ type: 'sender_text_typing', text: shuffledSender[senderIndex], delay: Math.round(typingTime) });
                        script.push({ type: 'message', sender: 'sender', text: shuffledSender[senderIndex], delay: Math.floor(Math.random() * 500) + 200 });
                        senderIndex++;
                    }
                    
                    // Gestione del turno del Destinatario se non è partito per primo nel loop
                    if (!startWithRecipient && recipientIndex < shuffledRecipientBody.length) {
                         script.push({ type: 'typing', delay: Math.floor(Math.random() * 1000) + 500 });
                        script.push({ type: 'message', sender: 'recipient', text: shuffledRecipientBody[recipientIndex], delay: Math.floor(Math.random() * 1500) + 1000 });
                        recipientIndex++;
                    }
                }
                
                return script;
            }

            // =================================================================
            // === LOGICA PER UNA SINGOLA CHAT ===
            // =================================================================

            class ChatController {
                constructor(id, script) {
                    this.chatWindow = document.getElementById(`chat-window-${id}`);
                    this.typingIndicator = document.getElementById(`typing-indicator-${id}`); 
                    this.inputTypingText = document.getElementById(`input-typing-text-${id}`); 
                    this.inputMessageTypingContainer = document.getElementById(`input-message-typing-container-${id}`);
                    this.inputMessageTyping = document.getElementById(`input-message-typing-${id}`); 
                    this.script = script;
                    this.id = id;
                }

                addMessage(text, senderClass) {
                    const messageElement = document.createElement('div');
                    messageElement.classList.add('message', senderClass);
                    messageElement.textContent = text;
                    this.chatWindow.insertBefore(messageElement, this.typingIndicator);
                    this.chatWindow.scrollTop = this.chatWindow.scrollHeight; 
                    
                    if (senderClass === 'recipient') {
                        receiveAudio.play().catch(e => console.log(`[Chat ${this.id}] Errore riproduzione audio ricezione:`, e));
                    }
                }

                showTyping() { 
                    this.typingIndicator.style.display = 'flex'; 
                    this.chatWindow.scrollTop = this.chatWindow.scrollHeight; 
                }
                hideTyping() { 
                    this.typingIndicator.style.display = 'none'; 
                }

                async typeSenderMessage(text, duration) {
                    this.inputTypingText.style.display = 'none';
                    this.inputMessageTypingContainer.style.display = 'flex'; 
                    this.inputMessageTyping.textContent = ''; 
                    
                    if (typingAudio.paused) {
                        typingAudio.play().catch(e => console.log(`[Chat ${this.id}] Errore riproduzione audio digitazione:`, e));
                    }
                    
                    const charDelay = duration / text.length; 
                    
                    for (let i = 0; i < text.length; i++) {
                        this.inputMessageTyping.textContent += text.charAt(i);
                        this.chatWindow.scrollTop = this.chatWindow.scrollHeight; 
                        await sleep(charDelay);
                    }
                    
                    typingAudio.pause();
                    typingAudio.currentTime = 0; 
                }

                resetInputBar() {
                    this.inputTypingText.style.display = 'block';
                    this.inputMessageTypingContainer.style.display = 'none';
                    this.inputMessageTyping.textContent = '';
                    
                    typingAudio.pause();
                    typingAudio.currentTime = 0;
                }

                async runScript() {
                    this.hideTyping();
                    this.resetInputBar();

                    for (const step of this.script) {
                        await sleep(step.delay);

                        if (step.type === 'message') {
                            this.hideTyping();
                            this.resetInputBar(); 
                            this.addMessage(step.text, step.sender);
                        } else if (step.type === 'typing') { 
                            this.showTyping();
                        } else if (step.type === 'sender_text_typing') { 
                            await this.typeSenderMessage(step.text, step.delay);
                        }
                    }

                    // *** MODIFICA CHIAVE: Pausa di 10 secondi ***
                    await sleep(10000); 

                    // Pulisci i messaggi
                    const messages = this.chatWindow.querySelectorAll('.message');
                    messages.forEach(msg => msg.remove());
                    
                    this.hideTyping();
                    this.resetInputBar();

                    await sleep(500);
                    // Riavvia con un nuovo script randomico
                    let newScript;
                    do {
                        newScript = generateRandomScript();
                    } while (JSON.stringify(newScript) === JSON.stringify(this.script)); // Assicura che sia diverso dalla precedente esecuzione

                    this.script = newScript;
                    this.runScript(); 
                }
            }

            // =================================================================
            // === AVVIO DELLE DUE CHAT ===
            // =================================================================

            // Genera due script iniziali e diversi
            let script1 = generateRandomScript();
            let script2;

            do {
                script2 = generateRandomScript();
            } while (JSON.stringify(script1) === JSON.stringify(script2)); // Assicura che siano diversi tra loro

            // Crea e avvia i controller per le due chat
            const chat1 = new ChatController(1, script1);
            const chat2 = new ChatController(2, script2);

            chat1.runScript();
            sleep(Math.random() * 1000).then(() => chat2.runScript());

        });
    </script>

</body>
</html>
